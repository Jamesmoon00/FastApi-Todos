<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>To-Do List</title>
    <style>
      body {
        font-family: "Noto Sans KR", sans-serif;
        background-color: #f7f9fb;
        color: #333;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        padding: 40px 20px;
      }
      h1 {
        color: #1e88e5;
        margin-bottom: 20px;
      }
      form {
        display: flex;
        gap: 10px;
        margin-bottom: 30px;
        flex-wrap: wrap;
      }

      input[type="text"],
      select#priority {
        padding: 10px 12px;
        border: 1px solid #ccc;
        border-radius: 8px;
        outline: none;
        transition: 0.2s;
      }
      input[type="text"]:focus,
      select#priority:focus {
        border-color: #1e88e5;
        box-shadow: 0 0 4px rgba(30, 136, 229, 0.4);
      }

      button {
        background-color: #1e88e5;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 10px 16px;
        cursor: pointer;
        font-weight: bold;
        transition: 0.2s;
      }
      button:hover {
        background-color: #1565c0;
      }

      ul {
        list-style: none;
        padding: 0;
        width: 100%;
        max-width: 600px;
      }
      li {
        background-color: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        padding: 12px 16px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        gap: 8px;
      }
      .left {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .right {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      li button {
        padding: 6px 10px;
        font-size: 13px;
        margin: 0;
      }
      .btn-edit {
        background-color: #ffb300;
      }
      .btn-edit:hover {
        background-color: #f57c00;
      }
      .btn-del {
        background-color: #e53935;
      }
      .btn-del:hover {
        background-color: #c62828;
      }

      .priority-badge {
        margin-left: 6px;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 12px;
        border: 1px solid #e0e0e0;
      }
      .priority-badge.high {
        background: #ffebee;
      }
      .priority-badge.none {
        background: #f5f5f5;
        color: #777;
      }
      .empty {
        color: #777;
        text-align: center;
      }
      .filter {
        display: flex;
        gap: 8px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        width: 100%;
        max-width: 600px;
      }
      .filter input {
        flex: 1;
        min-width: 160px;
        padding: 10px 12px;
        border: 1px solid #ccc;
        border-radius: 8px;
      }
      .section {
        width: 100%;
        max-width: 600px;
        margin-bottom: 16px;
      }
      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }
      .section-title {
        margin: 0;
        font-size: 18px;
        color: #1e88e5;
      }
      .toggle-btn {
        background: none;
        color: #1e88e5;
        border: 1px solid #1e88e5;
        padding: 6px 10px;
        border-radius: 20px;
        font-size: 13px;
      }
      .toggle-btn:hover {
        background: #e3f2fd;
      }
      .hidden {
        display: none;
      }
      .completed-item {
        opacity: 0.8;
        text-decoration: line-through;
        background: #f4f6f8;
      }
      .muted {
        color: #777;
      }
    </style>
  </head>
  <body>
    <h1>To-Do List</h1>

    <div class="filter">
      <input type="text" id="filter-user" placeholder="사용자 이름으로 필터" />
      <button type="button" id="apply-filter">필터 적용</button>
      <button type="button" id="reset-filter">전체 보기</button>
    </div>

    <div class="section">
      <div class="section-header">
        <h2 class="section-title">할 일</h2>
      </div>
      <ul id="todo-list"></ul>
    </div>

    <div class="section">
      <div class="section-header">
        <h2 class="section-title muted">완료됨</h2>
        <button type="button" id="toggle-completed" class="toggle-btn">
          완료 목록 열기
        </button>
      </div>
      <ul id="completed-list" class="hidden"></ul>
    </div>

    <form id="todo-form">
      <input type="text" id="title" placeholder="할일" required />
      <input type="text" id="description" placeholder="이름" required />
      <select id="priority" aria-label="우선순위">
        <option value="none" selected>-</option>
        <option value="high">높음</option>
      </select>
      <button type="submit">추가</button>
    </form>

    <script>
      // ---- 정렬 유틸: high 우선, 동순위는 최신(id 큰 값) 먼저 ----
      const priorityWeight = { high: 0, none: 1, undefined: 1, null: 1 };
      function normalizePriority(p) {
        return p === "high" ? "high" : "none";
      }
      function sortByPriorityThenTime(list) {
        return list.slice().sort((a, b) => {
          const wa = priorityWeight[normalizePriority(a.priority)];
          const wb = priorityWeight[normalizePriority(b.priority)];
          if (wa !== wb) return wa - wb; // high 먼저
          return (b.id ?? 0) - (a.id ?? 0); // 최신 먼저
        });
      }

      // ---- 렌더 ----
      function render(todos) {
        const todoList = document.getElementById("todo-list");
        const completedList = document.getElementById("completed-list");
        todoList.innerHTML = "";
        completedList.innerHTML = "";

        // 미완료만 표시
        const active = todos.filter((t) => !t.completed);
        if (active.length === 0) {
          const li = document.createElement("li");
          li.className = "empty";
          li.textContent = "할 일이 없습니다.";
          todoList.appendChild(li);
        } else {
          const sorted = sortByPriorityThenTime(active);

          sorted.forEach((todo) => {
            const li = document.createElement("li");

            // 왼쪽(체크박스+라벨)
            const left = document.createElement("div");
            left.className = "left";

            const cb = document.createElement("input");
            cb.type = "checkbox";
            cb.checked = false;
            cb.title = "완료로 표시";
            cb.addEventListener("change", async () => {
              if (cb.checked) {
                await fetch(`/todos/${todo.id}`, {
                  method: "PUT",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ ...todo, completed: true }),
                });
                fetchTodos(currentFilterUser);
              }
            });

            const label = document.createElement("span");
            label.textContent = `${todo.title}: ${todo.description}`;

            const badge = document.createElement("span");
            const p = normalizePriority(todo.priority);
            badge.textContent = p === "high" ? "HIGH" : "-";
            badge.className = "priority-badge " + p;

            left.appendChild(cb);
            left.appendChild(label);
            left.appendChild(badge);

            // 오른쪽(수정/삭제)
            const right = document.createElement("div");
            right.className = "right";

            const editButton = document.createElement("button");
            editButton.className = "btn-edit";
            editButton.textContent = "수정";
            editButton.onclick = async () => {
              const title = prompt("새로운 할 일을 입력하세요:", todo.title);
              if (title === null) return;
              const description = prompt(
                "새 이름을 입력하세요:",
                todo.description
              );
              if (description === null) return;
              const priorityRaw = prompt(
                "우선순위 (high/none):",
                normalizePriority(todo.priority)
              );
              if (priorityRaw === null) return;
              const priority = normalizePriority(priorityRaw);

              const response = await fetch(`/todos/${todo.id}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  ...todo,
                  title,
                  description,
                  priority,
                  completed: false,
                }),
              });
              if (response.ok) fetchTodos(currentFilterUser);
            };

            const deleteButton = document.createElement("button");
            deleteButton.className = "btn-del";
            deleteButton.textContent = "삭제";
            deleteButton.onclick = async () => {
              const response = await fetch(`/todos/${todo.id}`, {
                method: "DELETE",
              });
              if (response.ok) fetchTodos(currentFilterUser);
            };

            right.appendChild(editButton);
            right.appendChild(deleteButton);

            li.appendChild(left);
            li.appendChild(right);
            todoList.appendChild(li);
          });
        }

        // 완료된 항목
        const completed = todos.filter((t) => t.completed);
        if (completed.length === 0) {
          const li = document.createElement("li");
          li.className = "empty";
          li.textContent = "완료된 항목이 없습니다.";
          completedList.appendChild(li);
        } else {
          sortByPriorityThenTime(completed).forEach((todo) => {
            const li = document.createElement("li");
            li.classList.add("completed-item");

            const left = document.createElement("div");
            left.className = "left";

            const label = document.createElement("span");
            label.textContent = `${todo.title}: ${todo.description}`;

            const badge = document.createElement("span");
            const p = normalizePriority(todo.priority);
            badge.textContent = p === "high" ? "HIGH" : "-";
            badge.className = "priority-badge " + p;

            left.appendChild(label);
            left.appendChild(badge);

            const right = document.createElement("div");
            right.className = "right";

            const undoButton = document.createElement("button");
            undoButton.textContent = "되돌리기";
            undoButton.className = "btn-edit";
            undoButton.onclick = async () => {
              const response = await fetch(`/todos/${todo.id}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ ...todo, completed: false }),
              });
              if (response.ok) fetchTodos(currentFilterUser);
            };

            const deleteButton = document.createElement("button");
            deleteButton.className = "btn-del";
            deleteButton.textContent = "삭제";
            deleteButton.onclick = async () => {
              const response = await fetch(`/todos/${todo.id}`, {
                method: "DELETE",
              });
              if (response.ok) fetchTodos(currentFilterUser);
            };

            right.appendChild(undoButton);
            right.appendChild(deleteButton);

            li.appendChild(left);
            li.appendChild(right);
            completedList.appendChild(li);
          });
        }
      }

      // ---- API 래퍼 ----
      let currentFilterUser = "";
      const filterInput = document.getElementById("filter-user");
      const applyFilterButton = document.getElementById("apply-filter");
      const resetFilterButton = document.getElementById("reset-filter");
      const toggleCompletedButton = document.getElementById("toggle-completed");
      const completedListElement = document.getElementById("completed-list");

      applyFilterButton.addEventListener("click", () => {
        fetchTodos(filterInput.value);
      });

      resetFilterButton.addEventListener("click", () => {
        filterInput.value = "";
        fetchTodos("");
      });

      // 완료 목록 토글
      toggleCompletedButton.addEventListener("click", () => {
        const hidden = completedListElement.classList.toggle("hidden");
        toggleCompletedButton.textContent = hidden
          ? "완료 목록 열기"
          : "완료 목록 닫기";
      });

      function todosUrl() {
        return currentFilterUser
          ? `/todos?user=${encodeURIComponent(currentFilterUser)}`
          : "/todos";
      }

      async function fetchTodos(nextFilter) {
        if (typeof nextFilter === "string") {
          currentFilterUser = nextFilter.trim();
        }
        const response = await fetch(todosUrl());
        const todos = await response.json();
        // 서버가 priority를 안 줄 수도 있으니 기본값 보정
        const normalized = todos.map((t) => ({
          ...t,
          priority: normalizePriority(t.priority),
        }));
        render(normalized);
      }

      // ---- 폼 제출 ----
      document
        .getElementById("todo-form")
        .addEventListener("submit", async (event) => {
          event.preventDefault();
          const title = document.getElementById("title").value.trim();
          const description = document
            .getElementById("description")
            .value.trim();
          const priority = normalizePriority(
            document.getElementById("priority").value
          );

          if (!title || !description) return;

          const response = await fetch("/todos", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              id: Date.now(),
              title,
              description,
              priority, // high | none
              completed: false,
            }),
          });

          if (response.ok) {
            document.getElementById("title").value = "";
            document.getElementById("description").value = "";
            document.getElementById("priority").value = "none";
            fetchTodos();
          }
        });

      // 초기 로드
      fetchTodos();
    </script>
  </body>
</html>
