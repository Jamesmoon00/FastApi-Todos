<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>To-Do List</title>
    <style>
      body {
        font-family: "Noto Sans KR", sans-serif;
        background-color: #f7f9fb;
        color: #333;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        padding: 40px 20px;
      }
      h1 {
        color: #1e88e5;
        margin-bottom: 20px;
      }
      form {
        display: flex;
        gap: 10px;
        margin-bottom: 30px;
        flex-wrap: wrap;
      }

      input[type="text"],
      select#priority {
        padding: 10px 12px;
        border: 1px solid #ccc;
        border-radius: 8px;
        outline: none;
        transition: 0.2s;
      }
      input[type="text"]:focus,
      select#priority:focus {
        border-color: #1e88e5;
        box-shadow: 0 0 4px rgba(30, 136, 229, 0.4);
      }

      button {
        background-color: #1e88e5;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 10px 16px;
        cursor: pointer;
        font-weight: bold;
        transition: 0.2s;
      }
      button:hover {
        background-color: #1565c0;
      }

      ul {
        list-style: none;
        padding: 0;
        width: 100%;
        max-width: 600px;
      }
      li {
        background-color: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        padding: 12px 16px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        gap: 8px;
      }
      .left {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .right {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      li button {
        padding: 6px 10px;
        font-size: 13px;
        margin: 0;
      }
      .btn-edit {
        background-color: #ffb300;
      }
      .btn-edit:hover {
        background-color: #f57c00;
      }
      .btn-del {
        background-color: #e53935;
      }
      .btn-del:hover {
        background-color: #c62828;
      }

      .priority-badge {
        margin-left: 6px;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 12px;
        border: 1px solid #e0e0e0;
      }
      .priority-badge.high {
        background: #ffebee;
      }
      .priority-badge.none {
        background: #f5f5f5;
        color: #777;
      }
      .empty {
        color: #777;
        text-align: center;
      }
      .filter {
        display: flex;
        gap: 8px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        width: 100%;
        max-width: 600px;
      }
      .filter input {
        flex: 1;
        min-width: 160px;
        padding: 10px 12px;
        border: 1px solid #ccc;
        border-radius: 8px;
      }
    </style>
  </head>
  <body>
    <h1>To-Do List</h1>

    <div class="filter">
      <input type="text" id="filter-user" placeholder="사용자 이름으로 필터" />
      <button type="button" id="apply-filter">필터 적용</button>
      <button type="button" id="reset-filter">전체 보기</button>
    </div>

    <ul id="todo-list"></ul>

    <form id="todo-form">
      <input type="text" id="title" placeholder="할일" required />
      <input type="text" id="description" placeholder="이름" required />
      <select id="priority" aria-label="우선순위">
        <option value="none" selected>-</option>
        <option value="high">높음</option>
      </select>
      <button type="submit">추가</button>
    </form>

    <script>
      // ---- 정렬 유틸: high 우선, 동순위는 최신(id 큰 값) 먼저 ----
      const priorityWeight = { high: 0, none: 1, undefined: 1, null: 1 };
      function normalizePriority(p) {
        return p === "high" ? "high" : "none";
      }
      function sortByPriorityThenTime(list) {
        return list.slice().sort((a, b) => {
          const wa = priorityWeight[normalizePriority(a.priority)];
          const wb = priorityWeight[normalizePriority(b.priority)];
          if (wa !== wb) return wa - wb; // high 먼저
          return (b.id ?? 0) - (a.id ?? 0); // 최신 먼저
        });
      }

      // ---- 렌더 ----
      function render(todos) {
        const todoList = document.getElementById("todo-list");
        todoList.innerHTML = "";

        // 미완료만 표시
        const active = todos.filter((t) => !t.completed);
        if (active.length === 0) {
          const li = document.createElement("li");
          li.className = "empty";
          li.textContent = "할 일이 없습니다.";
          todoList.appendChild(li);
          return;
        }

        const sorted = sortByPriorityThenTime(active);

        sorted.forEach((todo) => {
          const li = document.createElement("li");

          // 왼쪽(체크박스+라벨)
          const left = document.createElement("div");
          left.className = "left";

          const cb = document.createElement("input");
          cb.type = "checkbox";
          cb.checked = false;
          cb.title = "완료로 표시";
          cb.addEventListener("change", async () => {
            if (cb.checked) {
              await fetch(`/todos/${todo.id}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ ...todo, completed: true }),
              });
              li.remove();
            }
          });

          const label = document.createElement("span");
          label.textContent = `${todo.title}: ${todo.description}`;

          const badge = document.createElement("span");
          const p = normalizePriority(todo.priority);
          badge.textContent = p === "high" ? "HIGH" : "-";
          badge.className = "priority-badge " + p;

          left.appendChild(cb);
          left.appendChild(label);
          left.appendChild(badge);

          // 오른쪽(수정/삭제)
          const right = document.createElement("div");
          right.className = "right";

          const editButton = document.createElement("button");
          editButton.className = "btn-edit";
          editButton.textContent = "수정";
          editButton.onclick = async () => {
            const title = prompt("새로운 할 일을 입력하세요:", todo.title);
            if (title === null) return;
            const description = prompt(
              "새 이름을 입력하세요:",
              todo.description
            );
            if (description === null) return;
            const priorityRaw = prompt(
              "우선순위 (high/none):",
              normalizePriority(todo.priority)
            );
            if (priorityRaw === null) return;
            const priority = normalizePriority(priorityRaw);

            const response = await fetch(`/todos/${todo.id}`, {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                ...todo,
                title,
                description,
                priority,
                completed: false,
              }),
            });
            if (response.ok) fetchTodos();
          };

          const deleteButton = document.createElement("button");
          deleteButton.className = "btn-del";
          deleteButton.textContent = "삭제";
          deleteButton.onclick = async () => {
            const response = await fetch(`/todos/${todo.id}`, {
              method: "DELETE",
            });
            if (response.ok) li.remove();
          };

          right.appendChild(editButton);
          right.appendChild(deleteButton);

          li.appendChild(left);
          li.appendChild(right);
          todoList.appendChild(li);
        });
      }

      // ---- API 래퍼 ----
      let currentFilterUser = "";
      const filterInput = document.getElementById("filter-user");
      const applyFilterButton = document.getElementById("apply-filter");
      const resetFilterButton = document.getElementById("reset-filter");

      applyFilterButton.addEventListener("click", () => {
        fetchTodos(filterInput.value);
      });

      resetFilterButton.addEventListener("click", () => {
        filterInput.value = "";
        fetchTodos("");
      });

      function todosUrl() {
        return currentFilterUser
          ? `/todos?user=${encodeURIComponent(currentFilterUser)}`
          : "/todos";
      }

      async function fetchTodos(nextFilter) {
        if (typeof nextFilter === "string") {
          currentFilterUser = nextFilter.trim();
        }
        const response = await fetch(todosUrl());
        const todos = await response.json();
        // 서버가 priority를 안 줄 수도 있으니 기본값 보정
        const normalized = todos.map((t) => ({
          ...t,
          priority: normalizePriority(t.priority),
        }));
        render(normalized);
      }

      // ---- 폼 제출 ----
      document
        .getElementById("todo-form")
        .addEventListener("submit", async (event) => {
          event.preventDefault();
          const title = document.getElementById("title").value.trim();
          const description = document
            .getElementById("description")
            .value.trim();
          const priority = normalizePriority(
            document.getElementById("priority").value
          );

          if (!title || !description) return;

          const response = await fetch("/todos", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              id: Date.now(),
              title,
              description,
              priority, // high | none
              completed: false,
            }),
          });

          if (response.ok) {
            document.getElementById("title").value = "";
            document.getElementById("description").value = "";
            document.getElementById("priority").value = "none";
            fetchTodos();
          }
        });

      // 초기 로드
      fetchTodos();
    </script>
  </body>
</html>
